---
import { getImage } from "astro:assets";
import Layout from "../layouts/Layout.astro";
import Tags from "../components/Tags.astro";
import TagsFilter from "../components/TagsFilter.svelte";
import { postImageImport } from "../helpers/images.mjs";
import { Alert } from "flowbite-svelte";
import { PenSolid } from "flowbite-svelte-icons";

const POSTS_PATH = "posts";
const COVER_IMG_ASPECT_RATIO = "13/9"; // TODO: Expose as variable

const { showTagsFilter = true, showProfile = false, showOnlyTag = null } = Astro.props;

const posts = await Astro.glob("./posts/*.mdx");

const seenTags = {};
const tagsList = posts.reduce((acc, post) => {
  const postTags = post?.frontmatter?.tags;

  if (postTags) {
    postTags.forEach((tag) => {
      const id = tag.id;

      if (!seenTags[id]) {
        seenTags[id] = true;
        acc.push(tag);
      }
    });
  }

  return acc;
}, []);
---

<script>
  import { compact } from "../stores/compact";
  compact.subscribe((value) => {
    if (typeof document !== "undefined") {
      document.body.classList.toggle("compact", value);
    }
  });
  document.addEventListener("astro:after-swap", () => {
    compact.subscribe((value) => {
      if (typeof document !== "undefined") {
        document.body.classList.toggle("compact", value);
      }
    });
  });
</script>

<style is:global>
  /* Compact Mode Styles - "Minilist" Technical Blog Style */
  body.compact .post-cover-image {
    display: none !important;
  }
  
  body.compact .post-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    align-items: stretch !important; /* Fix alignment - override items-center */
  }

  body.compact .post-link-container {
    display: block;
    width: 100%;
    color: inherit;
    text-decoration: none;
  }
  
  /* Fix Tag Filter in Compact Mode */
  /* With display: block, standard hidden class works, but keeping this just in case of conflicts */
  body.compact .post-link-container.hidden {
    display: none !important;
  }

  body.compact .post-article {
    border: none;
    box-shadow: none;
    background: transparent !important;
    padding: 0.5rem; /* Add padding for hover effect */
    margin: 0;
    border-radius: 0.5rem; /* Rounded corners */
    transition: background-color 0.2s ease-in-out;
  }
  
  /* Hover Highlight Effect */
  body.compact .post-article:hover {
    transform: none;
    background-color: #f3f4f6 !important; /* gray-100 */
  }
  html.dark body.compact .post-article:hover {
    background-color: #1f2937 !important; /* gray-800 */
  }

  /* Compact Blog Header */
  body.compact .mx-auto.max-w-screen-2xl {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    padding-top: 1.5rem !important;
    padding-bottom: 0.5rem !important;
  }

  /* Title Wrapper */
  body.compact .mx-auto.mb-4.max-w-screen-sm.text-center {
    margin: 0 !important;
    text-align: left !important;
    width: auto !important;
    flex-grow: 0;
  }

  /* Title H1 */
  body.compact .mx-auto.mb-4.max-w-screen-sm.text-center h1 {
    font-size: 1.5rem !important;
    margin-bottom: 0 !important;
    letter-spacing: normal !important;
  }

  /* Subtitle H2 - Hide it */
  body.compact .mx-auto.mb-4.max-w-screen-sm.text-center h2 {
    display: none !important;
  }

  /* Tag Filter Wrapper */
  body.compact div:has(> #tags-select-container) {
    justify-content: flex-end !important;
    margin: 0 !important;
    width: auto !important;
  }
  
  /* Tag Selector Sizing */
  body.compact #tags-select-container {
    width: 12rem !important; /* Compact width */
  }

  /* Reduce height of the selector input */
  body.compact #tags-select-container button { 
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
      min-height: 2.2rem !important;
  }
  
  /* Hide the Tag Icon */
  body.compact div:has(> #tags-select-container) > svg {
    display: none !important;
  }

  /* Post List - Force new line */
  body.compact .post-list {
    width: 100%;
    margin-top: 1rem !important;
    order: 10;
    
    /* Re-apply flex column rules here just in case specific order matters */
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    align-items: stretch !important;
  }

  /* 1. Date Styling - Column 1 */
  body.compact .post-article .text-sm {
    grid-column: 1;
    grid-row: 1;
    font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
    font-size: 0.85rem;
    color: #6b7280;
    white-space: nowrap;
    
    /* Ensure Left Alignment */
    justify-self: start;
    text-align: left;
    width: 100%;
  }
  :global(.dark) body.compact .post-article .text-sm {
    color: #9ca3af;
  }

  /* Hide extra meta info (reading time, separator) */
  body.compact .post-article .text-sm span:not(:first-child) {
    display: none;
  }
  body.compact .post-article .text-sm span:first-child {
    display: inline-block;
    text-align: left;
    width: 100%;
  }
  body.compact .post-article .text-sm span span:nth-child(2) {
    display: none;
  }

  /* 2. Title Styling - Column 2, Row 1 */
  body.compact .post-article h2 {
    grid-column: 2;
    grid-row: 1;
    margin: 0;
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.5;
    color: #111827;
    text-decoration: none;
  }
  
  /* Dark Mode Title Fix */
  html.dark body.compact .post-article h2 {
    color: #e5e7eb !important;
  }
  
  body.compact .post-article:hover h2 {
    text-decoration: underline;
    text-decoration-color: #d1d5db;
  }

  /* 3. Tags Styling - Column 2, Row 2 */
  /* Target the Tags div (it's the first child usually, or we can check classes) */
  /* We use :first-child because in the markup it comes before H2 */
  body.compact .post-article > div.p-4 > div:first-child {
    grid-column: 2;
    grid-row: 2;
    display: flex !important;
    margin-bottom: 0 !important; /* Override default mb-4 */
    margin-top: 0.25rem;
    flex-wrap: wrap;
    gap: 0.5rem;
    /* Scale down slightly for hierarchy */
    font-size: 0.75rem; 
    opacity: 0.7;
  }

  /* Hide Descriptions */
  body.compact .post-article p.mb-4 {
    display: none;
  }
  
  /* Hide profile image section if present */
  body.compact .post-article .flex.items-center { 
    display: none; 
  }
</style>

<Layout title="Blog">
  <main class="">
    <section class="">
      <div class="mx-auto max-w-screen-2xl px-4 py-8 lg:px-6 lg:py-16">
        <div class="mx-auto mb-4 max-w-screen-sm text-center lg:mb-8">
          <h1
            class="mb-4 text-4xl font-extrabold tracking-tight text-gray-900 dark:text-white lg:text-5xl"
          >
            Blog
          </h1>
          <h2
            class="font-light text-gray-500 dark:text-gray-400 max-[375px]:text-xs sm:text-xl lg:text-2xl"
          >
            Articles, tutorials, videos, musings, and more
          </h2>
        </div>

        {showTagsFilter && (showOnlyTag == null) && tagsList.length > 1 && <TagsFilter tagsList={tagsList} client:load />}

        <div
          class="post-list mt-8 grid items-center gap-8 md:grid-cols-2 lg:mt-16 xl:grid-cols-3"
        >
          {
            posts
              .sort((postA, postB) => {
                const aDate = new Date(postA.frontmatter.publish_date);
                const bDate = new Date(postB.frontmatter.publish_date);
                return bDate.getTime() - aDate.getTime();
              })
              .map(async (post) => {
                const { cover, title } = post?.frontmatter;
                const dateStr = new Date(
                  post.frontmatter.publish_date,
                ).toLocaleString("en-US", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                });

                let optimizedCoverImage: any = null;
                let coverImageSrc: string = "";
                let preloadCoverImageSrc: string = "";
                let preloadCoverImageMobileSrc: string = "";

                if (cover) {
                  const imageFilePath = (await postImageImport(cover)).default;

                  optimizedCoverImage = await getImage({
                    src: imageFilePath,
                    width: 1400,
                  });

                  coverImageSrc = (
                    await getImage({
                      src: imageFilePath,
                      width: 1400,
                    })
                  ).src;

                  preloadCoverImageSrc = (
                    await getImage({
                      src: imageFilePath,
                      width: 1920,
                      height: 1080,
                    })
                  ).src;

                  preloadCoverImageMobileSrc = (
                    await getImage({
                      src: imageFilePath,
                      width: 720,
                      height: 480,
                    })
                  ).src;

                  coverImageSrc = (optimizedCoverImage as any).src;
                }

                return (
                  <a
                    href={`/${POSTS_PATH}/${post.frontmatter.slug}`}
                    class={
                      "post-link-container contents " +
                      post.frontmatter.tags
                        .map((tag) => `post-link-tag-${tag.id}`)
                        .join(" ")
                    }
                  >
                    <article class="post-article h-fit transform rounded-lg border border-gray-200 bg-white shadow-md transition duration-100 ease-in dark:border-gray-700 dark:bg-gray-800 sm:hover:scale-[102%] lg:hover:scale-105">
                      <div
                        class="post-cover-image"
                        style={`view-transition-name: cover-image-${post.frontmatter.id};`}
                      >
                        {post.frontmatter.status !== "published" && (
                          <Alert color="yellow">
                            <PenSolid slot="icon" class="h-4 w-4" />
                            Edit this <span class="font-extrabold">
                              draft
                            </span>{" "}
                            post in{" "}
                            <a
                              href="notion.so"
                              target="blank"
                              class="font-semibold"
                            >
                              Notion
                            </a>
                          </Alert>
                        )}

                        {cover && (
                          <>
                            <img
                              class={`mb-1 h-auto w-full rounded-md rounded-b-none object-cover`}
                              style={`aspect-ratio: ${COVER_IMG_ASPECT_RATIO}`}
                              src={coverImageSrc}
                              alt="cover"
                            />

                            <link
                              rel="prefetch"
                              href={preloadCoverImageSrc}
                              as="image"
                            />

                            <link
                              rel="prefetch"
                              href={preloadCoverImageMobileSrc}
                              as="image"
                            />
                          </>
                        )}
                      </div>
                      <div
                        class="p-4"
                        style={`view-transition-name: cover-title-${post.frontmatter.id};`}
                      >
                        <Tags tags={post.frontmatter.tags} />

                        <h2 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
                          {post.frontmatter.title}
                        </h2>

                        <p
                          class="mb-4 whitespace-pre-line font-light text-gray-500 dark:text-gray-400"
                          set:html={
                            post.frontmatter.description !== "undefined"
                              ? post.frontmatter.description
                              : ""
                          }
                        />

                        {/* Author Section */}
                        { showProfile ? (
                          <div class="flex items-center space-x-3">
                            <img
                              class="h-11 w-11 rounded-full"
                              src="/images/portrait.webp"
                              alt="Buzz's avatar"
                            />
                            <div class="font-medium dark:text-white">
                              <div>Fizzbuzz Aldrin</div>
                              <div class="text-sm font-normal text-gray-500 dark:text-gray-400">
                                <span
                                  class={
                                    !post.frontmatter.publish_date ? "hidden" : ""
                                  }
                                >
                                  <span>{dateStr}</span>
                                  <span> · </span>
                                </span>
                                <span>{post.frontmatter.reading_time}</span>
                              </div>
                            </div>
                          </div>
                      ) : (
                      <div class="text-sm font-normal text-gray-500 dark:text-gray-400">
                                <span
                                  class={
                                    !post.frontmatter.publish_date ? "hidden" : ""
                                  }
                                >
                                  <span>{dateStr}</span>
                                  <span> · </span>
                                </span>
                                <span>{post.frontmatter.reading_time}</span>
                              </div>

                      )}
                    </div>
                    </article>
                  </a>
                );
              })
          }
        </div>
      </div>
    </section>
  </main>
</Layout>
